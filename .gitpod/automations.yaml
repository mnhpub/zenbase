# Zenbase Automations Configuration
# Integrates with Screwdriver CI for orchestration
# Manages development environment and CI/CD workflows

tasks:
    install:
        name: Install Dependencies
        description: Install backend and frontend dependencies
        command: |
            echo "üì¶ Installing dependencies..."
            make install
        triggeredBy:
            - manual
            - postEnvironmentStart

    build:
        name: Build Application
        description: Build the application using build script
        command: |
            echo "üî® Building application..."
            make build
        triggeredBy:
            - manual

    test:
        name: Run Tests
        description: Run tests with docker-compose
        command: |
            echo "üß™ Running tests..."
            make test
        triggeredBy:
            - manual

    lint:
        name: Lint Code
        description: Run ESLint on frontend code
        command: |
            echo "üîç Linting code..."
            cd frontend && npm run lint
        triggeredBy:
            - manual

    validate:
        name: Validate Configuration
        description: Validate docker-compose configuration
        command: |
            echo "‚úÖ Validating configuration..."
            make validate
        triggeredBy:
            - manual

    health-check:
        name: Health Check
        description: Run health checks on services
        command: |
            echo "üè• Running health checks..."
            make health
        triggeredBy:
            - manual

    # Screwdriver CI integration tasks
    sd-build:
        name: Screwdriver Build
        description: Screwdriver CI build step
        command: |
            echo "üî® Running Screwdriver build..."
            make sd-build
        triggeredBy:
            - manual

    sd-test:
        name: Screwdriver Test
        description: Screwdriver CI test step
        command: |
            echo "üß™ Running Screwdriver tests..."
            make sd-test
        triggeredBy:
            - manual

    sd-deploy:
        name: Screwdriver Deploy
        description: Screwdriver CI deploy step
        command: |
            echo "üöÄ Running Screwdriver deploy..."
            make sd-deploy
        triggeredBy:
            - manual

services:
    backend:
        name: Backend API
        description: Express.js backend API server
        commands:
            start: |
                cd backend
                export NODE_ENV=development
                export PORT=3000
                export SUPABASE_URL=${SUPABASE_URL}
                export SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
                export CORS_ORIGIN=http://localhost:5173
                npm run dev
            ready: |
                max_attempts=30
                attempt=0
                while [ $attempt -lt $max_attempts ]; do
                    if curl -f http://localhost:3000/health 2>/dev/null; then
                        echo "‚úÖ Backend service is ready"
                        exit 0
                    fi
                    attempt=$((attempt + 1))
                    sleep 1
                done
                echo "‚ùå Backend service failed to start"
                exit 1
        triggeredBy:
            - manual

    frontend:
        name: Frontend Application
        description: React + Vite frontend application
        commands:
            start: |
                cd frontend
                export SUPABASE_URL=${SUPABASE_URL}
                export SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
                export API_URL=http://localhost:3000
                npm run dev
            ready: |
                max_attempts=30
                attempt=0
                while [ $attempt -lt $max_attempts ]; do
                    if curl -f http://localhost:5173 2>/dev/null; then
                        echo "‚úÖ Frontend service is ready"
                        exit 0
                    fi
                    attempt=$((attempt + 1))
                    sleep 1
                done
                echo "‚ùå Frontend service failed to start"
                exit 1
        triggeredBy:
            - manual
